<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mini HaxBall Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;background:#222;color:white;font-family:sans-serif;text-align:center;}
canvas{background:#3b8b3b;border:3px solid white;margin-top:10px;}
#menu{margin-top:40px;}
#joystick{position:fixed;bottom:20px;left:20px;width:120px;height:120px;background:rgba(255,255,255,0.1);border-radius:50%;}
#stick{width:60px;height:60px;background:rgba(255,255,255,0.3);border-radius:50%;position:absolute;top:30px;left:30px;}
#kickBtn{position:fixed;bottom:40px;right:40px;padding:15px;}
</style>
</head>

<body>

<h2 id="score">0 : 0</h2>

<div id="menu">
<button onclick="createRoom()">Crear Sala</button>
<button onclick="joinRoom()">Unirse a Sala</button>
</div>

<canvas id="game" width="800" height="400" style="display:none"></canvas>

<div id="joystick" style="display:none">
<div id="stick"></div>
</div>

<button id="kickBtn" style="display:none">Patear</button>

<script src="/socket.io/socket.io.js"></script>

<script>

const socket = io();

let roomCode=null;
let isHost=false;

const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let ball={x:400,y:200,vx:0,vy:0};
let players=[{x:100,y:200},{x:700,y:200}];
let score=[0,0];

let joy={x:0,y:0};
let kick=false;

/* --- SALAS --- */

function createRoom(){
socket.emit("createRoom");
}

socket.on("roomCreated", code=>{
roomCode=code;
isHost=true;
alert("Código: "+code);
});

function joinRoom(){
const code=prompt("Código sala");
roomCode=code;
socket.emit("joinRoom",code);
}

socket.on("startGame",startGame);

socket.on("gameState",state=>{
if(!isHost){
players=state.players;
ball=state.ball;
score=state.score;
}
});

/* --- JOYSTICK --- */

const joystick=document.getElementById("joystick");
const stick=document.getElementById("stick");

joystick.addEventListener("touchmove",e=>{
const rect=joystick.getBoundingClientRect();
const t=e.touches[0];

let dx=t.clientX-rect.left-60;
let dy=t.clientY-rect.top-60;

const dist=Math.sqrt(dx*dx+dy*dy);
const max=60;

if(dist>max){
dx=dx/dist*max;
dy=dy/dist*max;
}

stick.style.left=(dx+30)+"px";
stick.style.top=(dy+30)+"px";

joy.x=dx/max;
joy.y=dy/max;
});

joystick.addEventListener("touchend",()=>{
joy.x=0; joy.y=0;
stick.style.left="30px";
stick.style.top="30px";
});

document.getElementById("kickBtn").ontouchstart=()=>kick=true;
document.getElementById("kickBtn").ontouchend=()=>kick=false;

/* --- JUEGO --- */

function resetBall(){
ball={x:400,y:200,vx:0,vy:0};
}

function update(){

let p=isHost?players[0]:players[1];

p.x+=joy.x*4;
p.y+=joy.y*4;

p.x=Math.max(20,Math.min(780,p.x));
p.y=Math.max(20,Math.min(380,p.y));

if(isHost){

let dx=ball.x-players[0].x;
let dy=ball.y-players[0].y;
let dist=Math.sqrt(dx*dx+dy*dy);

if(dist<40){
ball.vx=dx*0.15;
ball.vy=dy*0.15;
}

if(kick && dist<70){
ball.vx+=dx*0.2;
ball.vy+=dy*0.2;
}

ball.x+=ball.vx;
ball.y+=ball.vy;

ball.vx*=0.96;
ball.vy*=0.96;

if(ball.y<15||ball.y>385) ball.vy*=-1;

if(ball.x<10){ score[1]++; resetBall(); }
if(ball.x>790){ score[0]++; resetBall(); }

socket.emit("gameState",{code:roomCode,state:{players,ball,score}});

}

}

function draw(){
ctx.clearRect(0,0,800,400);

ctx.fillStyle="white";
ctx.fillRect(0,150,10,100);
ctx.fillRect(790,150,10,100);

players.forEach(p=>{
ctx.beginPath();
ctx.arc(p.x,p.y,20,0,Math.PI*2);
ctx.fillStyle="blue";
ctx.fill();
});

ctx.beginPath();
ctx.arc(ball.x,ball.y,15,0,Math.PI*2);
ctx.fillStyle="white";
ctx.fill();

document.getElementById("score").innerText=`${score[0]} : ${score[1]}`;
}

function gameLoop(){
update();
draw();
requestAnimationFrame(gameLoop);
}

function startGame(){
document.getElementById("menu").style.display="none";
canvas.style.display="block";
joystick.style.display="block";
document.getElementById("kickBtn").style.display="block";
gameLoop();
}

</script>
</body>
</html>